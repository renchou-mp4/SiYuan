{"ID":"20230611172003-dfbbii4","Spec":"1","Type":"NodeDocument","Properties":{"id":"20230611172003-dfbbii4","scroll":"{\u0026quot;rootId\u0026quot;:\u0026quot;20230611172003-oipjjj2\u0026quot;,\u0026quot;startId\u0026quot;:\u0026quot;20230611172003-w4hpyy7\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20230611172003-rbchbhu\u0026quot;,\u0026quot;scrollTop\u0026quot;:0,\u0026quot;focusId\u0026quot;:\u0026quot;20230611172003-w4hpyy7\u0026quot;,\u0026quot;focusStart\u0026quot;:0,\u0026quot;focusEnd\u0026quot;:0}","title":"C# ArrayPool","type":"doc","updated":"20230519172247"},"Children":[{"ID":"20230611172003-qm840nv","Type":"NodeParagraph","Properties":{"id":"20230611172003-qm840nv","updated":"20230428153525"},"Children":[{"Type":"NodeText","Data":".Net性能调优方案"}]},{"ID":"20230611172003-wopnejg","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230611172003-wopnejg","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"定义"}]},{"ID":"20230611172003-i1vmecf","Type":"NodeParagraph","Properties":{"id":"20230611172003-i1vmecf","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"高性能"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"托管"},{"Type":"NodeText","Data":"数组缓冲池，可重复使用，用"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"租用"},{"Type":"NodeText","Data":"空间的方式代替"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"重新分配"},{"Type":"NodeText","Data":"数组空间的行为"}]},{"ID":"20230611172003-wtwk54k","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230611172003-wtwk54k","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"好处"}]},{"ID":"20230611172003-p0w8gr3","Type":"NodeParagraph","Properties":{"id":"20230611172003-p0w8gr3","updated":"20230428160516"},"Children":[{"Type":"NodeText","Data":"可以在频繁创建和销毁数组的情况下"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"提高性能"},{"Type":"NodeText","Data":"，减少垃圾回收器的压力"}]},{"ID":"20230611172003-fy7esa3","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230611172003-fy7esa3","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"使用"}]},{"ID":"20230611172003-ex6gefe","Type":"NodeList","ListData":{},"Properties":{"id":"20230611172003-ex6gefe","updated":"20230428160509"},"Children":[{"ID":"20230611172003-2caerya","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230611172003-2caerya","updated":"20230428160509"},"Children":[{"ID":"20230611172003-e2u9i2y","Type":"NodeParagraph","Properties":{"id":"20230611172003-e2u9i2y","updated":"20230428160509"},"Children":[{"Type":"NodeText","Data":"获取缓冲池实例:"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Create"},{"Type":"NodeText","Data":"/"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Shared"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"var pool=ArrayPool[byte].Shared"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20230611172003-lhbykib","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230611172003-lhbykib","updated":"20230428153536"},"Children":[{"ID":"20230611172003-c4lfedr","Type":"NodeParagraph","Properties":{"id":"20230611172003-c4lfedr","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"调用缓冲池实例"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Rent()"},{"Type":"NodeText","Data":"函数，租用缓冲区空间 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"byte[] array=pool.Rent(1024)"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20230611172003-bwceb7u","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230611172003-bwceb7u","updated":"20230428153536"},"Children":[{"ID":"20230611172003-6onn9ym","Type":"NodeParagraph","Properties":{"id":"20230611172003-6onn9ym","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"调用缓冲池实例"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Return(array[T])"},{"Type":"NodeText","Data":"函数,归还租用的空间 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"pool.Return(array)"},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20230611172003-0h29x6i","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230611172003-0h29x6i","updated":"20230428160805"},"Children":[{"Type":"NodeText","Data":"Shared"}]},{"ID":"20230611172003-nz2z90v","Type":"NodeParagraph","Properties":{"id":"20230611172003-nz2z90v","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"Shared返回为一个静态共享实例，实际返回了一个"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"TlsOverPerCoreLockedStacksArrayPool"}]},{"ID":"20230611172003-p91nlp1","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230611172003-p91nlp1","updated":"20230428160556"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YyM="},{"Type":"NodeCodeBlockCode","Data":"internal sealed class TlsOverPerCoreLockedStacksArrayPool\u003cT\u003e : ArrayPool\u003cT\u003e\n{\n    private static readonly TlsOverPerCoreLockedStacksArrayPool\u003cT\u003e s_shared = new TlsOverPerCoreLockedStacksArrayPool\u003cT\u003e();\n\n    public static ArrayPool\u003cT\u003e Shared =\u003e s_shared;\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230611172003-3fkb4tj","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20230611172003-3fkb4tj","updated":"20230428160830"},"Children":[{"Type":"NodeText","Data":"特点"}]},{"ID":"20230611172003-eo6mob6","Type":"NodeList","ListData":{},"Properties":{"id":"20230611172003-eo6mob6","updated":"20230428160719"},"Children":[{"ID":"20230611172003-jyb9yvu","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230611172003-jyb9yvu","updated":"20230428153536"},"Children":[{"ID":"20230611172003-fmic4tc","Type":"NodeParagraph","Properties":{"id":"20230611172003-fmic4tc","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"租用数组长度不可超过 2^20( 1024*1024 = 1 048 576)，否则会从GC中重新开辟内存空间"}]}]},{"ID":"20230611172003-cdu50ic","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230611172003-cdu50ic","updated":"20230428160719"},"Children":[{"ID":"20230611172003-4qr83rg","Type":"NodeParagraph","Properties":{"id":"20230611172003-4qr83rg","updated":"20230428160719"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Rent"},{"Type":"NodeText","Data":"租用数组实际返回的长度可能比请求的长度大，返回长度一般是(16*2^n)"}]}]},{"ID":"20230611172003-4ryfs4g","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230611172003-4ryfs4g","updated":"20230428153536"},"Children":[{"ID":"20230611172003-45dh2g2","Type":"NodeParagraph","Properties":{"id":"20230611172003-45dh2g2","updated":"20230428153536"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Return"},{"Type":"NodeText","Data":"归还缓冲区的时候，如果不设置"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"clearArray"},{"Type":"NodeText","Data":"，下一个租用者可能会看到之前的填充的值（在返回的数组长度刚好是下一个租用者请求的长度时会被看到）"}]}]},{"ID":"20230611172003-60jn4uo","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230611172003-60jn4uo","updated":"20230428153536"},"Children":[{"ID":"20230611172003-td8vfhm","Type":"NodeParagraph","Properties":{"id":"20230611172003-td8vfhm","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"缓冲池的内存释放不是实时释放，在缓冲区空闲时，大概10到20秒之后，会随着第2代GC一起释放，分批释放"}]}]},{"ID":"20230611172003-25a0gy9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230611172003-25a0gy9","updated":"20230428153536"},"Children":[{"ID":"20230611172003-lxl1th3","Type":"NodeParagraph","Properties":{"id":"20230611172003-lxl1th3","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"并发数量持续增长时，缓冲池占用的内存空间也会持续增长，而且似乎没有上限"}]}]}]},{"ID":"20230611172003-93vblac","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20230611172003-93vblac","updated":"20230428160836"},"Children":[{"Type":"NodeText","Data":"耗时对比"}]},{"ID":"20230611172003-e57afur","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230611172003-e57afur","updated":"20230428160917"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YyM="},{"Type":"NodeCodeBlockCode","Data":"private static void TimeMonitor()\n{\n    //随机生成3000个数组的长度值\n    var sizes = new int[30000];\n    Parallel.For(0, 10000, x =\u003e { sizes[x] = new Random().Next(1024 * 800, 1024 * 1024); });\n\n    //缓冲池方式租用数组\n    var gcAllocate0 = GC.GetTotalAllocatedBytes();\n    var watch = new Stopwatch();\n    Console.WriteLine(\"start\");\n    watch.Start();\n    for (int i = 0; i \u003c 10000; i++)\n    {\n        //CreateArrayByPool(ArrayPool\u003cint\u003e.Shared, 1024 * 1024,sizes[i], false);\n\n        var arr = ArrayPool\u003cint\u003e.Shared.Rent(sizes[i]);\n        for (int j = 0; j \u003c sizes[i]; j++)\n        {\n            arr[j] = i;\n        }\n        ArrayPool\u003cint\u003e.Shared.Return(arr, true);\n    }\n    var time1 = watch.ElapsedMilliseconds;\n    var gcAllocate1 = GC.GetTotalAllocatedBytes(true);\n\n    //new 方式分配数组空间\n    watch.Restart();\n    for (int i = 0; i \u003c 30000; i++)\n    {\n        //CreateArrayDefault(i, sizes[i], false);\n        var arr = new int[sizes[i]];\n        for (int j = 0; j \u003c sizes[i]; j++)\n        {\n            arr[j] = i;\n        }\n    }\n    var time2 = watch.ElapsedMilliseconds;\n    var gcAllocate2 = GC.GetTotalAllocatedBytes(true);\n\n    Console.WriteLine(\"ArrayPool方式创建数组耗时：\" + time1 + \"  Gc总分配量\" + (gcAllocate1 - gcAllocate0));\n    Console.WriteLine(\"默认方式创建数组耗时：\" + time2 + \"  Gc总分配量\" + (gcAllocate2 - gcAllocate1 - gcAllocate0));\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230611172003-imfl8hs","Type":"NodeParagraph","Properties":{"id":"20230611172003-imfl8hs","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"内存使用截图：左侧没有波动的横线是缓冲池执行的过程，右侧为手动创建数组的执行过程"}]},{"ID":"20230611172003-8vegozd","Type":"NodeParagraph","Properties":{"id":"20230611172003-8vegozd","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://ask.qcloudimg.com/http-save/yehe-1682101/fd554066bb366734240d1fb518daa229.png?imageView2/2/w/2560/h/7000"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20230611172003-ebt550b","Type":"NodeParagraph","Properties":{"id":"20230611172003-ebt550b","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"执行结果："}]},{"ID":"20230611172003-mullmec","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230611172003-mullmec","updated":"20230428153536"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YXNjcmlwdA=="},{"Type":"NodeCodeBlockCode","Data":"ArrayPool方式创建数组耗时：17545  Gc总分配量4130800\n默认方式创建数组耗时：26870  Gc总分配量37354100896\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230611172003-75xwdjc","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20230611172003-75xwdjc","updated":"20230428160847"},"Children":[{"Type":"NodeText","Data":"示例（前端文件通过后端Api上传OSS）"}]},{"ID":"20230611172003-sorp93k","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230611172003-sorp93k","updated":"20230428160904"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YyM="},{"Type":"NodeCodeBlockCode","Data":"private static void PostFileByBytesPool(FormFile file)\n{\n    HttpClient client = new HttpClient() { BaseAddress = new Uri(\"https://fileserver.com\") };\n\n    var fileLen = (int)file.Length;\n    var fileArr = ArrayPool\u003cbyte\u003e.Shared.Rent(fileLen);\n\n    using var stream = file.OpenReadStream();\n    stream.Read(fileArr, 0, fileLen);\n\n    MultipartFormDataContent content = new MultipartFormDataContent();\n    content.Add(new ByteArrayContent(fileArr, 0, fileLen), \"id_\" + Guid.NewGuid().ToString(), file.FileName);\n\n    client.PostAsync(\"/myfile/\" + file.FileName, content).Wait();\n    ArrayPool\u003cbyte\u003e.Shared.Return(fileArr, true);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230611172003-28qgkc8","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230611172003-28qgkc8","updated":"20230428160935"},"Children":[{"Type":"NodeText","Data":"Create()"}]},{"ID":"20230611172003-9v6zmrz","Type":"NodeParagraph","Properties":{"id":"20230611172003-9v6zmrz","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"ArrayPool的Create()函数会创建一个"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"ConfigurableArrayPool"},{"Type":"NodeText","Data":"对象"}]},{"ID":"20230611172003-hp3mmqt","Type":"NodeParagraph","Properties":{"id":"20230611172003-hp3mmqt","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"ConfigurableArrayPool的构造函数接收两个参数"}]},{"ID":"20230611172003-37uips1","Type":"NodeList","ListData":{},"Properties":{"id":"20230611172003-37uips1","updated":"20230428153536"},"Children":[{"ID":"20230611172003-bddhfn1","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230611172003-bddhfn1","updated":"20230428153536"},"Children":[{"ID":"20230611172003-n3w0wkw","Type":"NodeParagraph","Properties":{"id":"20230611172003-n3w0wkw","updated":"20230428153536"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"maxArrayLength"},{"Type":"NodeText","Data":"：单次租借的数组最大长度，不可超过"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"1024*1024*1024"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20230611172003-k9mftf1","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230611172003-k9mftf1","updated":"20230428153536"},"Children":[{"ID":"20230611172003-c484tyo","Type":"NodeParagraph","Properties":{"id":"20230611172003-c484tyo","updated":"20230428153536"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"maxArraysPerBucket"},{"Type":"NodeText","Data":"：最多可以存在的未归还缓冲区数量"}]}]}]},{"ID":"20230611172003-g8l7r5t","Type":"NodeParagraph","Properties":{"id":"20230611172003-g8l7r5t","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"通过这两个参数可以解决"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Shared"},{"Type":"NodeText","Data":"方式的两个问题："}]},{"ID":"20230611172003-tahq1qg","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230611172003-tahq1qg","updated":"20230428153536"},"Children":[{"ID":"20230611172003-lzr5rgy","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230611172003-lzr5rgy","updated":"20230428153536"},"Children":[{"ID":"20230611172003-af2hvjr","Type":"NodeParagraph","Properties":{"id":"20230611172003-af2hvjr","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"自定义单个数组的最大长度，可以获取更大的内存空间用来存储大文件等"}]}]},{"ID":"20230611172003-eiakp0w","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230611172003-eiakp0w","updated":"20230428153536"},"Children":[{"ID":"20230611172003-b3e7nw4","Type":"NodeParagraph","Properties":{"id":"20230611172003-b3e7nw4","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"限定了数组的长度和最大缓冲区数量，就限定了最大的不可回收内存数量，防止高并发时缓冲池内存持续增长"}]}]}]},{"ID":"20230611172003-5evybgv","Type":"NodeParagraph","Properties":{"id":"20230611172003-5evybgv","updated":"20230428153536"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"示例"}]},{"ID":"20230611172003-wzhhis2","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230611172003-wzhhis2","updated":"20230428153536"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YXNjcmlwdA=="},{"Type":"NodeCodeBlockCode","Data":"//创建一个自定义缓冲池实例，单个数组最大长度为1024 * 2048，最大可同时租用10个缓冲区\nArrayPool\u003cint\u003e CustomerArrayPool = ArrayPool\u003cint\u003e.Create(1024 * 2048,10);\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230611172003-1dctbbi","Type":"NodeParagraph","Properties":{"id":"20230611172003-1dctbbi","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"与Shared不同的是，如果设置"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"CustomerArrayPool=Null"},{"Type":"NodeText","Data":"​那么在下一次垃圾回收时该缓冲池所占的内存会立马全部释放。"}]},{"ID":"20230611172003-596lvfj","Type":"NodeParagraph","Properties":{"id":"20230611172003-596lvfj","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"为防止不可预测的风险，应该保持CustomerArrayPool的存活。"}]},{"ID":"20230611172003-a3ipywf","Type":"NodeParagraph","Properties":{"id":"20230611172003-a3ipywf","updated":"20230428153536"},"Children":[{"Type":"NodeText","Data":"同时为了防止内存的滥用应该限制CustomerArrayPool的数量"}]},{"ID":"20230611172003-rfx9eut","Type":"NodeParagraph","Properties":{"id":"20230611172003-rfx9eut","updated":"20230428152223"}},{"ID":"20230611172003-ltvs40l","Type":"NodeParagraph","Properties":{"id":"20230611172003-ltvs40l"}},{"ID":"20230611172003-q053ldh","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230611172003-q053ldh","updated":"20230428181835"},"Children":[{"Type":"NodeText","Data":"相关问题"}]},{"ID":"20230611172003-wx735ja","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230611172003-wx735ja","updated":"20230428180238"},"Children":[{"Type":"NodeText","Data":"ArrayPool的池级结构"}]},{"ID":"20230611172003-a27202u","Type":"NodeParagraph","Properties":{"id":"20230611172003-a27202u","updated":"20230428175943"},"Children":[{"Type":"NodeText","Data":"ArrayPool由若干个Bucket组成，每个Bucket由若干个"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"buffer[]"},{"Type":"NodeText","Data":"​数组组成。"}]},{"ID":"20230611172003-ry0zpkr","Type":"NodeParagraph","Properties":{"id":"20230611172003-ry0zpkr","updated":"20230428182019"},"Children":[{"Type":"NodeText","Data":"​​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://pic4.zhimg.com/80/v2-cad59ecb31c15b70f5848ac55b265edb_720w.webp"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​​"}]},{"ID":"20230611172003-aes4evn","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230611172003-aes4evn","updated":"20230428182149"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YyM="},{"Type":"NodeCodeBlockCode","Data":"public abstract class ArrayPool\u003cT\u003e\n{\n    public static ArrayPool\u003cT\u003e Create()\n    {\n        return new ConfigurableArrayPool\u003cT\u003e();\n    }\n}\n\ninternal sealed class ConfigurableArrayPool\u003cT\u003e : ArrayPool\u003cT\u003e\n{\n    private sealed class Bucket\n    {\n        internal readonly int _bufferLength;\n        private readonly T[][] _buffers;\n        private int _index;\n    }\n\n    private readonly Bucket[] _buckets;     //bucket数组\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230611172003-mnu565o","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230611172003-mnu565o","updated":"20230428182057"},"Children":[{"Type":"NodeText","Data":"Bucket中的Buffer数量"}]},{"ID":"20230611172003-u7uks8j","Type":"NodeParagraph","Properties":{"id":"20230611172003-u7uks8j","updated":"20230428182258"},"Children":[{"Type":"NodeText","Data":"初始化时做了"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"maxArrayPerBucket=50"},{"Type":"NodeText","Data":"​的设定，也可以自定义。"}]},{"ID":"20230611172003-4c03u2m","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230611172003-4c03u2m","updated":"20230428182310"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YyM="},{"Type":"NodeCodeBlockCode","Data":"internal sealed class ConfigurableArrayPool\u003cT\u003e : ArrayPool\u003cT\u003e\n{\n    internal ConfigurableArrayPool() : this(1048576, 50)\n    {\n    }\n\n    internal ConfigurableArrayPool(int maxArrayLength, int maxArraysPerBucket)\n    {\n        int num = Utilities.SelectBucketIndex(maxArrayLength);\n        Bucket[] array = new Bucket[num + 1];\n        for (int i = 0; i \u003c array.Length; i++)\n        {\n            array[i] = new Bucket(Utilities.GetMaxSizeForBucket(i), maxArraysPerBucket, id);\n        }\n        _buckets = array;\n    }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230611172003-nflm8iw","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230611172003-nflm8iw","updated":"20230428182359"},"Children":[{"Type":"NodeText","Data":"Bucket中buffer[].length为什么依次是16、32、64..."}]},{"ID":"20230611172003-obf9srm","Type":"NodeParagraph","Properties":{"id":"20230611172003-obf9srm","updated":"20230428182552"},"Children":[{"Type":"NodeText","Data":"这是框架的默认设定，第一个bucket中的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"buffer[].length = 16"},{"Type":"NodeText","Data":"​，后续bucket中的length都是x2累计。"}]},{"ID":"20230611172003-pykkvho","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230611172003-pykkvho","updated":"20230428182602"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YyM="},{"Type":"NodeCodeBlockCode","Data":"internal ConfigurableArrayPool(int maxArrayLength, int maxArraysPerBucket)\n{\n    Bucket[] array = new Bucket[num + 1];\n    for (int i = 0; i \u003c array.Length; i++)\n    {\n        array[i] = new Bucket(Utilities.GetMaxSizeForBucket(i), maxArraysPerBucket, id);\n    }\n}\n\ninternal static int GetMaxSizeForBucket(int binIndex)\n{\n    return 16 \u003c\u003c binIndex;\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230611172003-tsuuflw","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230611172003-tsuuflw","updated":"20230428183302"},"Children":[{"Type":"NodeText","Data":"初始Bucket数量"}]},{"ID":"20230611172003-vnlln2i","Type":"NodeParagraph","Properties":{"id":"20230611172003-vnlln2i","updated":"20230428183346"},"Children":[{"Type":"NodeText","Data":"初始有17个bucket。因为"}]},{"ID":"20230611172003-c9i6dzt","Type":"NodeParagraph","Properties":{"id":"20230611172003-c9i6dzt","updated":"20230428183415"},"Children":[{"Type":"NodeText","Data":"maxArrayLength = 1048576 = 2的20次方"}]},{"ID":"20230611172003-ngql8pu","Type":"NodeParagraph","Properties":{"id":"20230611172003-ngql8pu","updated":"20230428183440"},"Children":[{"Type":"NodeText","Data":"buffer.length = 16 = 2的4次方"}]},{"ID":"20230611172003-yvf7am7","Type":"NodeParagraph","Properties":{"id":"20230611172003-yvf7am7","updated":"20230428183614"},"Children":[{"Type":"NodeText","Data":"取次方的差值："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"bucket[].length = 20 - 4 + 1 = 17"},{"Type":"NodeText","Data":"​。即最后一个bucket下的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"buffer[].length = 1048576"},{"Type":"NodeText","Data":"​"}]},{"ID":"20230611172003-3u5ze6g","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230611172003-3u5ze6g","updated":"20230428183634"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YyM="},{"Type":"NodeCodeBlockCode","Data":"internal sealed class ConfigurableArrayPool\u003cT\u003e : ArrayPool\u003cT\u003e\n{\n    internal ConfigurableArrayPool(): this(1048576, 50)\n    { }\n\n    internal ConfigurableArrayPool(int maxArrayLength, int maxArraysPerBucket)\n    {\n        int num = Utilities.SelectBucketIndex(maxArrayLength);\n        Bucket[] array = new Bucket[num + 1];\n        for (int i = 0; i \u003c array.Length; i++)\n        {\n            array[i] = new Bucket(Utilities.GetMaxSizeForBucket(i), maxArraysPerBucket, id);\n        }\n        _buckets = array;\n    }\n\n    internal static int SelectBucketIndex(int bufferSize)\n    {\n        return BitOperations.Log2((uint)(bufferSize - 1) | 0xFu) - 3;\n    }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230611172003-31arxyi","Type":"NodeParagraph","Properties":{"id":"20230611172003-31arxyi"}},{"ID":"20230611172003-lwglvfo","Type":"NodeParagraph","Properties":{"id":"20230611172003-lwglvfo"}},{"ID":"20230611172003-7ft2hjs","Type":"NodeParagraph","Properties":{"id":"20230611172003-7ft2hjs"}},{"ID":"20230611172003-8y0tsux","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230611172003-8y0tsux","updated":"20230428163516"},"Children":[{"Type":"NodeText","Data":"参考"}]},{"ID":"20230611172003-ht667tt","Type":"NodeParagraph","Properties":{"id":"20230611172003-ht667tt","updated":"20230428163551"},"Children":[{"Type":"NodeText","Data":"1、"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://cloud.tencent.com/developer/article/1880253","TextMarkTextContent":".Net性能调优-ArrayPool - 腾讯云开发者社区-腾讯云 (tencent.com)"}]},{"ID":"20230611172003-7xs1sb0","Type":"NodeParagraph","Properties":{"id":"20230611172003-7xs1sb0","updated":"20230428183647"},"Children":[{"Type":"NodeText","Data":"2、"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://zhuanlan.zhihu.com/p/405634396","TextMarkTextContent":"ArrayPool 源码解读之 byte[] 也能池化？ - 知乎 (zhihu.com)"}]},{"ID":"20230611172003-py32960","Type":"NodeParagraph","Properties":{"id":"20230611172003-py32960"}}]}